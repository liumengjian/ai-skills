# 十七、接口动态文本配置

接口动态文本配置功能用于实现页面文本的动态化，支持通过接口配置页面上的文本内容，避免硬编码。页面上的文本可以根据接口返回的数据动态变化。

### 1. 功能说明

- **功能来源**：功能来源于 `@cqsjjb/jjb-common-decorator/namespace` 中的 `Interpolation` 高阶组件

- **核心作用**：将页面上的硬编码文本替换为接口配置的动态文本，实现文本的可配置化

- **应用场景**：

  - 表格列标题的动态配置

  - 页面标签、按钮文本的动态配置

  - 表单字段名称的动态配置

### 2. Interpolation 使用方式

- **导入方式**：

  ```javascript
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';
  ```

- **使用方式**：使用高阶组件（HOC）包裹页面组件

  ```javascript
  import React from 'react';
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';

  function UserList(props) {
    const { interpolation, insert, columns } = props;
    
    // 使用 insert 方法获取字段重命名文本
    const userNameLabel = insert('userName') || '用户名';
    
    // 使用 columns 方法处理表格列配置
    const tableColumns = columns([
      { fieldCode: 'userName', dataIndex: 'name', width: 200 },
      { fieldCode: 'email', dataIndex: 'email', width: 200 },
      { dataIndex: 'phone', title: '手机号', width: 150 } // 没有 fieldCode 的列不受影响
    ]);
    
    return (
      <div>
        <div>{userNameLabel}: 张三</div>
        <Table columns={tableColumns} dataSource={data} />
      </div>
    );
  }

  // 使用 Interpolation 包裹组件
  export default Interpolation(UserList);
  ```

### 3. 注入的 Props

- **interpolation**：字段配置对象

  - `interpolation.map`：字段码到字段对象的映射，键为 `fieldCode`，值为字段配置对象

  - `interpolation.list`：字段配置数组，包含所有字段配置信息

- **insert(fieldCode)**：获取字段重命名文本的方法

  - 参数 `fieldCode`：字段码（字符串）

  - 返回值：如果字段存在且可见（`visibleEnum` 为 false），返回 `fieldRename`（字段重命名文本），否则返回 `false`

  - 使用场景：用于获取单个字段的重命名文本，通常用于表单标签、页面文本等

  - **特殊字段 `DEFAULT_MENU`**：

    - 每个页面后端都会返回一个默认值 `DEFAULT_MENU`，表示页面的默认标题

    - 该值可以用于 `PageLayout` 组件的 `title` 属性，但**不是必须的**

    - 使用示例：`const pageTitle = insert('DEFAULT_MENU') || '默认标题';`

- **columns(columns)**：处理表格列配置的方法

  - 参数 `columns`：表格列配置数组

  - 返回值：处理后的表格列配置数组

  - 处理逻辑：

    - 遍历列配置数组

    - 如果列配置包含 `fieldCode`，则查找对应的字段配置

    - 如果字段存在且可见（`visibleEnum` 为 false），则用 `fieldRename` 替换 `title`

    - 如果字段不可见，则过滤掉该列（返回 `false`）

    - 如果列配置不包含 `fieldCode`，则保持原样

### 4. 字段配置获取机制

- **接口调用**：组件挂载时自动调用 `/system/operation/menus/menu-field/by-path` 接口获取字段配置

- **接口参数**：`{ path: window.location.pathname }`

- **接口返回数据结构**：

  ```javascript
  {
    data: [
      {
        fieldCode: 'userName',      // 字段码
        fieldRename: '用户姓名',     // 字段重命名文本
        visibleEnum: false           // 是否可见（false 表示可见）
      },
      {
        fieldCode: 'email',
        fieldRename: '电子邮箱',
        visibleEnum: false
      }
    ]
  }
  ```

### 5. 使用示例

- **表格列动态配置**：

  ```javascript
  import React from 'react';
  import { Table } from 'antd';
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';

  function UserList({ columns, dataSource }) {
    // 定义列配置，使用 fieldCode 标识需要动态配置的列
    const tableColumns = columns([
      { fieldCode: 'userName', dataIndex: 'name', width: 200 },
      { fieldCode: 'email', dataIndex: 'email', width: 200 },
      { fieldCode: 'phone', dataIndex: 'phone', width: 150 },
      { dataIndex: 'createTime', title: '创建时间', width: 180 } // 无 fieldCode，使用固定标题
    ]);

    return <Table columns={tableColumns} dataSource={dataSource} />;
  }

  export default Interpolation(UserList);
  ```

- **表单字段标签动态配置**：

  ```javascript
  import React from 'react';
  import { Form, Input } from 'antd';
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';

  function UserForm({ insert }) {
    return (
      <Form>
        <Form.Item label={insert('userName') || '用户名'}>
          <Input />
        </Form.Item>
        <Form.Item label={insert('email') || '电子邮箱'}>
          <Input />
        </Form.Item>
      </Form>
    );
  }

  export default Interpolation(UserForm);
  ```

- **页面文本动态配置**：

  ```javascript
  import React from 'react';
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';

  function UserDetail({ insert }) {
    const userNameLabel = insert('userName') || '用户名';
    const emailLabel = insert('email') || '电子邮箱';
    
    return (
      <div>
        <div>{userNameLabel}: 张三</div>
        <div>{emailLabel}: zhangsan@example.com</div>
      </div>
    );
  }

  export default Interpolation(UserDetail);
  ```

- **页面标题动态配置**：

  ```javascript
  import React from 'react';
  import { PageLayout } from '@cqsjjb/jjb-react-admin-component';
  import { Interpolation } from '@cqsjjb/jjb-common-decorator/namespace';

  function UserList({ insert }) {
    // 获取页面默认标题（可选，不是必须的）
    const pageTitle = insert('DEFAULT_MENU') || '用户列表';
    
    return (
      <PageLayout title={pageTitle}>
        {/* 页面内容 */}
      </PageLayout>
    );
  }

  export default Interpolation(UserList);
  ```

### 6. 使用规范

- **字段码规范**：

  - 字段码（`fieldCode`）应与后端接口返回的字段码保持一致

  - 字段码使用小驼峰命名，例如：`userName`、`email`、`phoneNumber`

- **列配置规范**：

  - 需要动态配置标题的列必须包含 `fieldCode` 属性

  - 不需要动态配置的列可以不包含 `fieldCode`，使用固定的 `title`

- **页面标题规范**：

  - `DEFAULT_MENU` 是后端返回的页面默认标题，可以通过 `insert('DEFAULT_MENU')` 获取

  - 该值可以用于 `PageLayout` 组件的 `title` 属性，但**不是必须的**，可根据实际需求选择是否使用

  - 建议提供兜底标题，例如：`insert('DEFAULT_MENU') || '默认标题'`

- **兜底处理**：

  - 使用 `insert` 方法时，建议提供兜底文本，例如：`insert('userName') || '用户名'`

  - 如果接口未返回字段配置或字段不可见，使用兜底文本确保页面正常显示

- **注意事项**：

  - 字段配置数据加载期间，`interpolation.map` 和 `interpolation.list` 为空对象/数组

  - 字段的可见性由 `visibleEnum` 控制，`false` 表示可见，`true` 表示不可见

  - 不可见的字段会被 `columns` 方法过滤掉，不会在表格中显示
