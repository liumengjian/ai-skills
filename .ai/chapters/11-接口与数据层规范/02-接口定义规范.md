# 十一、接口与数据层规范

## 2. 接口定义规范 (declareRequest)

所有接口必须通过 `@cqsjjb/jjb-dva-runtime/declareRequest` 进行声明。该方法通过字符串 DSL 实现请求配置与数据处理。

必须严格参考对应 MD 文档或 d.ts 文件！

## 基本语法

```javascript
declareRequest(
  a?: string,  // 参数1：Loading 状态标识（可选）
  b: string,    // 参数2：请求表达式（必填）
  c?: string   // 参数3：响应数据处理表达式（可选）
)
```

## 参数说明

| 参数 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| a | string | 否 | 请求时绑定的 Loading 状态标识，例如 `"loading"`、`"confirmLoading"` |
| b | string | 是 | 请求表达式，格式：`Method [> @] URL`，支持完整 http[s] 路径 |
| c | string | 否 | 响应数据处理表达式，用于从响应结果中取值并赋给目标字段 |

## 定义示例

```javascript
// 示例1：获取试卷列表（完整参数）
export const getExamResDataAction = declareRequest(
  'examResDataLoading', // 参数1：Loading 状态字段名
  'Get > /com-train/exams', // 参数2：请求方法 > 接口路径
  'examResData: [] | res.data || [] & examResDataTotal: 0 | res.totalCount || 0' // 参数3：数据映射与默认值
);

// 示例2：仅定义请求（省略参数1和参数3）
export const getUserInfoAction = declareRequest(
  'Get > /api/user/{id}' // 仅必填参数
);

// 示例3：POST 请求使用 @ 标记
export const createUserAction = declareRequest(
  'createUserLoading',
  'Post > @/api/user', // @ 标记忽略 request 包裹层
  'userId: "" | res.data.id || ""'
);
```

## 命名格式

`[name]Action` 统一使用 **小驼峰 (camelCase)** 命名

## 请求表达式规范

- **格式**：`Method [> @] URL`

- **支持的 HTTP 方法**：

  - `Get`：GET 请求
  - `Post`：POST 请求
  - `Put`：PUT 请求
  - `Delete`：DELETE 请求
  - `Patch`：PATCH 请求

- **@ 标记说明**：

  - **作用**：忽略请求体中 `request` 对象的包裹层，直接传递数据

  - **限制**：**Get 请求不能使用 @**，其他请求方法可选

  - **示例**：

    ```javascript
    // ✅ POST 请求使用 @，忽略 request 包裹
    'Post > @/api/user'

    // ❌ GET 请求禁止使用 @
    'Get > @/api/user/{id}'  // 错误写法
    ```

- **URL 路径规范**：

  - **普通路径**：例如 `/api/xxx/list`

  - **模板插值**：支持占位符 `{}`，调用时会替换为参数值

    ```javascript
    // 示例：URL 模板插值
    'Get > /api/user/{id}'  // 调用时 {id} 会被替换为实际参数值
    ```

  - **完整 HTTP 路径**：支持完整的 http[s] 路径

  - **请求格式限制**：**仅支持 `application/json` 格式**，其他格式不支持

## 响应表达式规范

- **格式**：`targetField: defaultValue | expression & ...`

- **组成部分**：

  - `targetField`：目标字段名称

  - `defaultValue`：当结果为空时的默认值

  - `expression`：从响应对象中获取数据的 JS 表达式

  - `&`：支持多个字段连接

  - `res`：固定上下文对象，表示响应结果

- **示例**：

  ```javascript
  // 示例：多字段映射
  'dataSource: [] | res.data || [] & total: 0 | res.total || 0'
  ```

  表示：

  - 将结果赋值给 `dataSource`，默认值为 `[]`，优先取 `res.data`，如果为空则取 `[]`

  - `&` 连接下一个字段

  - 将结果赋值给 `total`，默认值为 `0`，优先取 `res.total`，如果为空则取 `0`

- **AI 约束**：**必须根据后端返回结构精确配置此映射**

## 使用规则总结

1. **@ 标记限制**：Get 请求不能用 `@`，其他请求方法可选

2. **URL 模板插值**：支持路径模板插值 `{id}`，调用时自动替换

3. **参数可选性**：参数 a（Loading 状态）、c（响应处理）可选，不写也能正常工作

4. **请求格式**：仅支持 `application/json` 格式
