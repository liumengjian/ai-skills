# åä¸‰ã€äº‘ç»„ä»¶ä½¿ç”¨è§„èŒƒ

## ä¸€ã€æ¦‚è¿°

äº‘ç»„ä»¶æ”¯æŒåŠ¨æ€åŠ è½½è¿œç¨‹ React ç»„ä»¶ï¼Œå®ç°ç»„ä»¶çš„è¿œç¨‹éƒ¨ç½²å’ŒåŠ¨æ€æ›´æ–°ã€‚

- **ç»„ä»¶åº“**ï¼š`@cqsjjb/jjb-cloud-component`
- **æ ¸å¿ƒç»„ä»¶**ï¼š`CloudComponent` - ç”¨äºåŠ è½½å’Œæ¸²æŸ“äº‘ç»„ä»¶
- **å·¥å…·å‡½æ•°**ï¼š`ImportCloudComponent` - æ‰‹åŠ¨å¯¼å…¥äº‘ç»„ä»¶æ¨¡å—
- **æ ·å¼ç®¡ç†**ï¼š`useUnMountCloudComponentStyle` - å¸è½½äº‘ç»„ä»¶æ ·å¼
- **å·²å‘å¸ƒçš„äº‘ç»„ä»¶æ£€ç´¢è¡¨**ï¼š[https://cdn.cqjjb.cn/](https://cdn.cqjjb.cn/) - æŸ¥çœ‹æ‰€æœ‰å·²å‘å¸ƒçš„äº‘ç»„ä»¶åˆ—è¡¨
- **å¯è§†åŒ–ç»„ä»¶å¸‚åœº**ï¼š[https://jcloud.cqjjb.cn/container/home](https://jcloud.cqjjb.cn/container/home) - å¯è§†åŒ–æµè§ˆå’Œé€‰æ‹©äº‘ç»„ä»¶

**ğŸ“ è¯´æ˜**ï¼šæœ¬æ–‡æ¡£ä»…ä»‹ç»å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº‘ç»„ä»¶ã€‚å¦‚ä½•å¼€å‘äº‘ç»„ä»¶ã€å¦‚ä½•å‘å¸ƒäº‘ç»„ä»¶ä¸åœ¨æœ¬æ–‡æ¡£èŒƒå›´å†…ã€‚

**âš ï¸ é‡è¦çº¦æŸ**ï¼šå¿…é¡»ä¸¥æ ¼å‚è€ƒå¯¹åº” MD æ–‡æ¡£æˆ– `.d.ts` æ–‡ä»¶ï¼ä¸å¾—çŒœæµ‹ç»„ä»¶å±æ€§ï¼

## äºŒã€å¯¼å…¥æ–¹å¼

```javascript
// å¯¼å…¥ CloudComponent ç»„ä»¶
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';

// æˆ–ä»ä¸»å…¥å£å¯¼å…¥
import { CloudComponent } from '@cqsjjb/jjb-cloud-component';

// å¯¼å…¥å·¥å…·å‡½æ•°
import { ImportCloudComponent, useUnMountCloudComponentStyle } from '@cqsjjb/jjb-cloud-component';
```

## ä¸‰ã€åŸºç¡€ç”¨æ³•

### 3.1 æœ€ç®€å•çš„ä½¿ç”¨

```javascript
import React from 'react';
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';

function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      componentProps={{
        title: "Hello World",
        count: 42
      }}
    />
  );
}
```

### 3.2 å¸¦ç”Ÿå‘½å‘¨æœŸé’©å­çš„ä½¿ç”¨

```javascript
import React from 'react';
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';

function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      componentProps={{
        title: "Hello World",
        count: 42
      }}
      onLoadStart={() => {
        console.log('å¼€å§‹åŠ è½½äº‘ç»„ä»¶');
      }}
      onLoadEnd={() => {
        console.log('äº‘ç»„ä»¶åŠ è½½å®Œæˆ');
      }}
      onMounted={(key, ref) => {
        console.log(`ç»„ä»¶ ${key} å·²æŒ‚è½½`);
        // å¯ä»¥è°ƒç”¨ç»„ä»¶æ–¹æ³•
        ref.updateData?.({ theme: 'dark' });
      }}
      onUpdated={(key, ref) => {
        console.log(`ç»„ä»¶ ${key} å·²æ›´æ–°`, ref);
      }}
      onDestroy={() => {
        console.log('ç»„ä»¶å·²é”€æ¯');
      }}
    />
  );
}
```

## å››ã€ç»„ä»¶å±æ€§è¯´æ˜

### 4.1 CloudComponent Props

| å±æ€§ | ç±»å‹ | å¿…éœ€ | é»˜è®¤å€¼ | æè¿° |
|------|------|------|--------|------|
| `from` | `string` | âœ… | - | äº‘ç»„ä»¶èµ„æºåœ°å€ï¼ˆURLï¼‰ |
| `componentKey` | `string` | âœ… | - | ç»„ä»¶å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„äº‘ç»„ä»¶å®ä¾‹ |
| `componentProps` | `Record<string, unknown>` | âŒ | `{}` | ä¼ é€’ç»™äº‘ç»„ä»¶çš„é¢å¤–å±æ€§ |
| `dependencies` | `Record<string, unknown>` | âŒ | `{}` | ç»„ä»¶ä¾èµ–ï¼Œä¼šä¸é»˜è®¤ä¾èµ–åˆå¹¶ |
| `cache` | `CacheStrategy` | âŒ | `'force-cache'` | ç¼“å­˜ç­–ç•¥ |
| `headers` | `Record<string, string>` | âŒ | `{}` | è¯·æ±‚å¤´ï¼Œç”¨äºéœ€è¦è®¤è¯çš„äº‘ç»„ä»¶èµ„æº |
| `initialize` | `boolean` | âŒ | `false` | æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ›´æ–° settings å’Œ dataSource |
| `componentRef` | `React.Ref<Record<string, unknown>>` | âŒ | - | ç»„ä»¶å¼•ç”¨ï¼Œç”¨äºè°ƒç”¨ç»„ä»¶æ–¹æ³• |
| `onLoadStart` | `() => void` | âŒ | - | å¼€å§‹åŠ è½½å›è°ƒ |
| `onLoadEnd` | `() => void` | âŒ | - | åŠ è½½å®Œæˆå›è°ƒ |
| `onMounted` | `(key: string, ref: ComponentRef) => void` | âŒ | - | ç»„ä»¶æŒ‚è½½å›è°ƒ |
| `onUpdated` | `(key: string, ref: UpdateRef) => void` | âŒ | - | ç»„ä»¶æ›´æ–°å›è°ƒ |
| `onDestroy` | `() => void` | âŒ | - | ç»„ä»¶é”€æ¯å›è°ƒ |

### 4.2 ç±»å‹å®šä¹‰

```typescript
// ç¼“å­˜ç­–ç•¥ç±»å‹
type CacheStrategy = 
  | 'default' 
  | 'force-cache' 
  | 'no-cache' 
  | 'no-store' 
  | 'only-if-cached' 
  | 'reload';

// ç»„ä»¶å¼•ç”¨ç±»å‹
interface ComponentRef {
  // ç»„ä»¶è¾“å‡ºçš„è¡¨å•é…ç½®
  formItems?: Record<string, unknown>;
  // ç»„ä»¶æ›´æ–°æ–¹æ³•
  updateData?: (settings?: Record<string, unknown>, dataSource?: unknown) => void;
}

// æ›´æ–°å¼•ç”¨ç±»å‹
interface UpdateRef {
  settings?: Record<string, unknown>;
  dataSource?: unknown;
}
```

## äº”ã€ä¾èµ–ç®¡ç†

### 5.1 é»˜è®¤å†…ç½®ä¾èµ–

æ‰€æœ‰äº‘ç»„ä»¶éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹ä¾èµ–ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’ï¼š

- `react` - React åº“
- `react-dom` - React DOM åº“
- `@cqsjjb/jjb-common-lib` - é€šç”¨å·¥å…·åº“ï¼ˆåŒæ—¶æä¾› `jjbCommonLib` åˆ«åï¼‰

### 5.2 è‡ªå®šä¹‰ä¾èµ–

```javascript
import React from 'react';
import lodash from 'lodash';
import moment from 'moment';
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';

function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      dependencies={{
        // è‡ªå®šä¹‰ä¾èµ–ï¼Œä¼šä¸é»˜è®¤ä¾èµ–åˆå¹¶
        'lodash': lodash,
        'moment': moment,
        // åŒåä¾èµ–ä¼šè¦†ç›–é»˜è®¤ä¾èµ–
        'react': customReact
      }}
    />
  );
}
```

**æ³¨æ„**ï¼š
- ç”¨æˆ·è‡ªå®šä¹‰ä¾èµ–ä¼šä¸é»˜è®¤ä¾èµ–åˆå¹¶
- åŒåä¾èµ–ä¼šè¢«ç”¨æˆ·è‡ªå®šä¹‰ä¾èµ–è¦†ç›–
- ä¾èµ–å€¼å¯ä»¥æ˜¯å‡½æ•°å¼•ç”¨ï¼ˆå¦‚ `require()` çš„ç»“æœï¼‰æˆ–ä»»ä½• JavaScript å¯¹è±¡

## å…­ã€ç”Ÿå‘½å‘¨æœŸé’©å­

### 6.1 onLoadStart / onLoadEnd

ç”¨äºå¤„ç†åŠ è½½çŠ¶æ€ï¼š

```javascript
function MyPage() {
  const [loading, setLoading] = React.useState(false);

  return (
    <>
      {loading && <Spin />}
      <CloudComponent
        from="https://example.com/my-component.js"
        componentKey="my-component"
        onLoadStart={() => setLoading(true)}
        onLoadEnd={() => setLoading(false)}
      />
    </>
  );
}
```

### 6.2 onMounted

ç»„ä»¶æŒ‚è½½åè°ƒç”¨ï¼Œå¯ä»¥è·å–ç»„ä»¶å¼•ç”¨å¹¶è°ƒç”¨ç»„ä»¶æ–¹æ³•ï¼š

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      onMounted={(key, ref) => {
        console.log(`ç»„ä»¶ ${key} å·²æŒ‚è½½`);
        
        // è·å–ç»„ä»¶è¾“å‡ºçš„è¡¨å•é…ç½®
        if (ref.formItems) {
          console.log('è¡¨å•é…ç½®:', ref.formItems);
        }
        
        // æ›´æ–°ç»„ä»¶æ•°æ®
        if (ref.updateData) {
          ref.updateData(
            { theme: 'dark', language: 'zh-CN' }, // settings
            { items: [1, 2, 3] } // dataSource
          );
        }
      }}
    />
  );
}
```

### 6.3 onUpdated

ç»„ä»¶æ›´æ–°åè°ƒç”¨ï¼š

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      onUpdated={(key, ref) => {
        console.log(`ç»„ä»¶ ${key} å·²æ›´æ–°`);
        console.log('è®¾ç½®:', ref.settings);
        console.log('æ•°æ®æº:', ref.dataSource);
      }}
    />
  );
}
```

### 6.4 onDestroy

ç»„ä»¶é”€æ¯æ—¶è°ƒç”¨ï¼Œç”¨äºæ¸…ç†èµ„æºï¼š

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      onDestroy={() => {
        console.log('ç»„ä»¶å·²é”€æ¯');
        // æ¸…ç†ç›¸å…³èµ„æº
      }}
    />
  );
}
```

## ä¸ƒã€é«˜çº§ç”¨æ³•

### 7.1 ä½¿ç”¨ componentRef

```javascript
import React from 'react';
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';

function MyPage() {
  const componentRef = React.useRef();

  const handleUpdate = () => {
    // é€šè¿‡ ref è°ƒç”¨ç»„ä»¶æ–¹æ³•
    componentRef.current?.updateData?.(
      { theme: 'light' },
      { items: [4, 5, 6] }
    );
  };

  return (
    <>
      <Button onClick={handleUpdate}>æ›´æ–°ç»„ä»¶æ•°æ®</Button>
      <CloudComponent
        from="https://example.com/my-component.js"
        componentKey="my-component"
        componentRef={componentRef}
      />
    </>
  );
}
```

### 7.2 ä½¿ç”¨ initialize

å½“ `initialize` ä¸º `true` æ—¶ï¼Œç»„ä»¶ä¼šåœ¨æŒ‚è½½æ—¶è‡ªåŠ¨è°ƒç”¨ `updateData` æ–¹æ³•åˆå§‹åŒ– settings å’Œ dataSourceï¼š

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      initialize={true}
      componentProps={{
        settings: { theme: 'dark' },
        dataSource: { items: [] }
      }}
    />
  );
}
```

### 7.3 ä½¿ç”¨ headersï¼ˆéœ€è¦è®¤è¯çš„èµ„æºï¼‰

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      headers={{
        'Authorization': 'Bearer token123',
        'X-Custom-Header': 'value'
      }}
    />
  );
}
```

### 7.4 ä½¿ç”¨ cache ç­–ç•¥

```javascript
function MyPage() {
  return (
    <CloudComponent
      from="https://example.com/my-component.js"
      componentKey="my-component"
      cache="no-cache" // ä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°åŠ è½½
    />
  );
}
```

## å…«ã€æ‰‹åŠ¨å¯¼å…¥äº‘ç»„ä»¶ï¼ˆImportCloudComponentï¼‰

å½“éœ€è¦æ‰‹åŠ¨æ§åˆ¶äº‘ç»„ä»¶çš„åŠ è½½æ—¶æœºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `ImportCloudComponent`ï¼š

```javascript
import { ImportCloudComponent } from '@cqsjjb/jjb-cloud-component';
import React, { useState, useEffect } from 'react';

function MyPage() {
  const [Component, setComponent] = useState(null);

  useEffect(() => {
    async function loadComponent() {
      try {
        const { module, styleId, isNewVersion } = await ImportCloudComponent({
          from: 'https://example.com/my-component.js',
          dependencies: {
            react: React
          },
          cache: 'force-cache',
          headers: {
            'Authorization': 'Bearer token'
          }
        });

        console.log('æ ·å¼ID:', styleId);
        console.log('æ˜¯å¦æ–°ç‰ˆ:', isNewVersion);
        console.log('ç»„ä»¶ä¿¡æ¯:', module.info);

        // æ–°ç‰ˆäº‘ç»„ä»¶éœ€è¦è°ƒç”¨å‡½æ•°è·å–ç»„ä»¶
        const CloudComponent = isNewVersion 
          ? module.default({ 
              ref: null,
              $$dependencies: { react: React }
            })
          : module.default;

        setComponent(() => CloudComponent);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
      }
    }

    loadComponent();
  }, []);

  if (!Component) {
    return <Spin />;
  }

  return <Component title="Hello" />;
}
```

## ä¹ã€æ ·å¼ç®¡ç†

### 9.1 è‡ªåŠ¨æ ·å¼ç®¡ç†

äº‘ç»„ä»¶çš„æ ·å¼ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°é¡µé¢ä¸­ï¼Œå¹¶åœ¨ç»„ä»¶é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†ã€‚

### 9.2 æ‰‹åŠ¨å¸è½½æ ·å¼

å½“éœ€è¦æ‰‹åŠ¨å¸è½½äº‘ç»„ä»¶æ ·å¼æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `useUnMountCloudComponentStyle`ï¼š

```javascript
import { useUnMountCloudComponentStyle } from '@cqsjjb/jjb-cloud-component';

function MyPage() {
  const styleId = 'style-id-123';

  const handleUnmount = () => {
    // æ‰‹åŠ¨å¸è½½æŒ‡å®šæ ·å¼çš„äº‘ç»„ä»¶
    useUnMountCloudComponentStyle(styleId);
  };

  return (
    <>
      <Button onClick={handleUnmount}>å¸è½½æ ·å¼</Button>
      {/* ... */}
    </>
  );
}
```

## åã€æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

### 10.1 å¿…é¡»éµå®ˆ

1. **ç»„ä»¶å±æ€§**ï¼šå¿…é¡»ä¸¥æ ¼å‚è€ƒ `cloud-component.d.ts` æ–‡ä»¶ï¼Œä¸å¾—çŒœæµ‹ç»„ä»¶å±æ€§
2. **ç½‘ç»œè¯·æ±‚**ï¼šç¡®ä¿äº‘ç»„ä»¶åœ°å€å¯è®¿é—®ï¼Œå»ºè®®æ·»åŠ é”™è¯¯å¤„ç†
3. **ä¾èµ–ç®¡ç†**ï¼šæ­£ç¡®é…ç½®ç»„ä»¶æ‰€éœ€çš„ä¾èµ–ï¼Œé¿å…ä¾èµ–ç¼ºå¤±é”™è¯¯
4. **æ ·å¼éš”ç¦»**ï¼šä½¿ç”¨æ ·å¼IDé¿å…æ ·å¼å†²çªï¼Œå¿…é¡»ä½¿ç”¨ `{cloudComponentStyleId}` å ä½ç¬¦
5. **é”™è¯¯å¤„ç†**ï¼šå®ç°é€‚å½“çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œé¿å…ç»„ä»¶åŠ è½½å¤±è´¥å¯¼è‡´é¡µé¢å´©æºƒ

### 10.2 æœ€ä½³å®è·µ

1. **ç»„ä»¶Keyå”¯ä¸€æ€§**ï¼šç¡®ä¿ `componentKey` åœ¨é¡µé¢ä¸­å”¯ä¸€ï¼Œé¿å…ç»„ä»¶å®ä¾‹å†²çª
2. **åŠ è½½çŠ¶æ€**ï¼šä½¿ç”¨ `onLoadStart` å’Œ `onLoadEnd` æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
3. **èµ„æºæ¸…ç†**ï¼šåœ¨ç»„ä»¶é”€æ¯æ—¶ä½¿ç”¨ `onDestroy` æ¸…ç†ç›¸å…³èµ„æº
4. **ç¼“å­˜ç­–ç•¥**ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç¼“å­˜ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ›´æ–°åŠæ—¶æ€§
5. **ç‰ˆæœ¬å…¼å®¹**ï¼šæ³¨æ„æ–°æ—§ç‰ˆæœ¬äº‘ç»„ä»¶çš„å…¼å®¹æ€§ï¼Œæ–°ç‰ˆäº‘ç»„ä»¶æ”¯æŒæ›´å¤šç‰¹æ€§

### 10.3 å¸¸è§é”™è¯¯

1. **ä¾èµ–ç¼ºå¤±**ï¼šäº‘ç»„ä»¶ä¸­ä½¿ç”¨äº†æœªåœ¨ `dependencies` ä¸­å£°æ˜çš„ä¾èµ–
2. **æ ·å¼å†²çª**ï¼šæœªä½¿ç”¨ `{cloudComponentStyleId}` å ä½ç¬¦å¯¼è‡´æ ·å¼å†²çª
3. **ç»„ä»¶Keyé‡å¤**ï¼šå¤šä¸ªäº‘ç»„ä»¶å®ä¾‹ä½¿ç”¨ç›¸åŒçš„ `componentKey`
4. **ç½‘ç»œé”™è¯¯**ï¼šæœªå¤„ç†äº‘ç»„ä»¶èµ„æºåŠ è½½å¤±è´¥çš„æƒ…å†µ
5. **å±æ€§çŒœæµ‹**ï¼šæœªå‚è€ƒ `.d.ts` æ–‡ä»¶ï¼ŒçŒœæµ‹ç»„ä»¶å±æ€§å¯¼è‡´ä½¿ç”¨é”™è¯¯

## åä¸€ã€å®Œæ•´ç¤ºä¾‹

```javascript
import React, { useState } from 'react';
import { Spin, Button, message } from 'antd';
import CloudComponent from '@cqsjjb/jjb-cloud-component/CloudComponent';
import { InjectContext } from '~/enumerate/context';

function MyPage() {
  const context = useContext(InjectContext);
  const [loading, setLoading] = useState(false);
  const componentRef = React.useRef();

  const handleUpdate = () => {
    componentRef.current?.updateData?.(
      { theme: 'light', language: 'zh-CN' },
      { items: [1, 2, 3, 4, 5] }
    );
    context.message.success('ç»„ä»¶æ•°æ®å·²æ›´æ–°');
  };

  return (
    <div>
      <Button onClick={handleUpdate} style={{ marginBottom: 16 }}>
        æ›´æ–°ç»„ä»¶æ•°æ®
      </Button>
      
      {loading && <Spin />}
      
      <CloudComponent
        from="https://example.com/my-component.js"
        componentKey="my-component-unique-key"
        componentProps={{
          title: "æˆ‘çš„äº‘ç»„ä»¶",
          count: 42
        }}
        dependencies={{
          lodash: require('lodash')
        }}
        cache="force-cache"
        headers={{
          'Authorization': 'Bearer token123'
        }}
        initialize={true}
        componentRef={componentRef}
        onLoadStart={() => {
          setLoading(true);
          console.log('å¼€å§‹åŠ è½½äº‘ç»„ä»¶');
        }}
        onLoadEnd={() => {
          setLoading(false);
          console.log('äº‘ç»„ä»¶åŠ è½½å®Œæˆ');
        }}
        onMounted={(key, ref) => {
          console.log(`ç»„ä»¶ ${key} å·²æŒ‚è½½`);
          if (ref.formItems) {
            console.log('è¡¨å•é…ç½®:', ref.formItems);
          }
        }}
        onUpdated={(key, ref) => {
          console.log(`ç»„ä»¶ ${key} å·²æ›´æ–°`, ref);
        }}
        onDestroy={() => {
          console.log('ç»„ä»¶å·²é”€æ¯');
        }}
      />
    </div>
  );
}

export default MyPage;
```
