# 二、应用配置与开发环境

### 1. 应用标识符与路由配置

- **应用标识符 (appIdentifier)**：

  - 位置：根目录 `jjb.config.js` 文件中的 `appIdentifier` 属性

  - 作用：
    - 作为应用的唯一标识符，`@cqsjjb/jjb-dva-runtime` 基于此属性自动生成应用路由的 `basename`
    - `@cqsjjb/scripts` 基于此属性实现构建产物的命名

  - 构建产物命名规则：`@cqsjjb/scripts` 会根据 `appIdentifier` 的值生成对应的构建产物目录和文件
    - 示例：当 `appIdentifier = 'myApp'` 时，构建产物结构为：
      ```
      dist/
      ├── myApp/
      │   └── static/
      │       └── ...
      └── myApp.html
      ```

  - 修改方式：在根目录 `jjb.config.js` 文件的 `appIdentifier` 节点中进行配置

### 2. 文件别名与路径规范

- **路径别名**：统一使用 `~` 作为 `src` 目录的别名

  - 示例：`import { NS_GLOBAL } from '~/enumerate/namespace';`

  - 说明：`~` 指向 `src` 目录，所有导入路径应使用此别名以保持一致性

### 3. 图片和文件资源

- **导入方式**：使用 ESM 方式导入图片和文件资源

- **资源导入示例**：

  ```javascript
  // 图片
  import logo from '~/assets/image/logo.png';

  // 音频
  import audio from '~/assets/media/audio.mp3';

  // 视频
  import video from '~/assets/media/video.mp4';

  // 字体 ttf
  import font1 from '~/assets/file/font.ttf';

  // 字体 woff
  import font2 from '~/assets/file/font.woff';

  // 字体 eot
  import font3 from '~/assets/file/font.eot';
  ```

- **使用导入的资源**：

  ```javascript
  // 使用图片
  function App1() {
    return <img src={logo} alt="Logo" />;
  }

  // 使用视频
  function App2() {
    return <video src={video} controls />;
  }
  ```

- **资源类型支持**：

  - **图片资源**：支持 `.png`、`.jpg`、`.jpeg`、`.gif`、`.svg`、`.webp` 等常见图片格式

  - **媒体资源**：支持 `.mp3`、`.mp4`、`.wav`、`.ogg` 等音频和视频格式

  - **字体资源**：支持 `.ttf`、`.woff`、`.woff2`、`.eot` 等字体文件格式

  - **其他文件**：支持其他静态资源文件，如 `.pdf`、`.txt` 等

- **路径规范**：

  - 所有资源文件应放在 `src/assets/` 目录下，按类型分类存放

  - 推荐目录结构：

    ```
    src/
    └── assets/
        ├── images/      # 图片资源
        ├── media/      # 音频、视频资源
        └── fonts/       # 字体及其他文件资源
    ```

  - 导入时统一使用路径别名 `~` 指向 `src` 目录

- **注意事项**：

  - 资源文件导入后，构建工具会自动处理文件路径和文件名（包含 hash），确保资源正确加载

  - 导入的资源变量可以直接在 JSX 中使用，无需额外处理

  - 建议为图片添加 `alt` 属性，提升可访问性

  - 视频和音频资源建议添加相应的控制属性（如 `controls`、`autoplay` 等）

### 4. 样式和预处理样式

- **CSS 样式导入**：使用 ESM 方式导入 CSS 样式文件

  ```javascript
  import './index.css';
  ```

- **LESS 样式导入**：使用 ESM 方式导入 LESS 样式文件

  ```javascript
  import './index.less';
  ```

- **支持的样式格式**：

  - **CSS**：支持 `.css` 格式的样式文件

  - **LESS**：支持 `.less` 格式的预处理样式文件

  - **格式限制**：**微应用仅支持 `.css` 和 `.less` 样式文件，其他格式（如 `.scss`、`.sass`、`.stylus` 等）不支持，禁止使用**

- **注意事项**：

  - 样式文件导入后会自动应用到当前组件或页面

  - LESS 文件支持嵌套、变量、混合等预处理特性

  - 样式文件路径可以使用相对路径或路径别名 `~`

  - 建议将样式文件与对应的组件文件放在同一目录下，便于管理

### 5. Babel 配置管理

- **配置文件**：应用的 Babel 配置统一在根目录 `jjb.babel.js` 文件中进行管理

  - 说明：所有 Babel 相关配置（如插件、预设等）应在此文件中统一维护，禁止在项目其他位置分散配置

### 6. TypeScript 开发配置

- **安装依赖**：

  ```bash
  yarn add ts-loader typescript -D
  ```

- **Webpack 配置**：在 `jjb.config.js` 文件的 `webpackConfig` 节点中添加 TypeScript 文件处理规则

  ```javascript
  // jjb.config.js
  {
    // ... 其他配置
    webpackConfig: {
      htmlWebpackPluginOption: {
        inject: true
      },
      module: {
        rules: [
          // 添加ts文件规则
          {
            test: /\.(ts|tsx)$/,
            loader: 'ts-loader'
          }
        ]
      }
    }
  }
  ```

- **TypeScript 配置文件**：在根目录新建 `tsconfig.json` 文件，配置内容如下：

  ```json
  {
    "compilerOptions": {
      "module": "commonjs",
      "target": "es5",
      "jsx": "react",
      "allowSyntheticDefaultImports": true,
      "experimentalDecorators": true,
      "baseUrl": "./",
      "paths": {
        "~/*": ["src/*"]
      }
    },
    "exclude": [
      "node_modules"
    ]
  }
  ```

- **配置说明**：

  - **module**：指定模块系统，使用 `"commonjs"` 兼容 Node.js 环境

  - **target**：编译目标 ES 版本，使用 `"es5"` 确保浏览器兼容性

  - **jsx**：指定 JSX 处理方式，使用 `"react"` 支持 React 组件

  - **allowSyntheticDefaultImports**：允许从没有默认导出的模块中默认导入

  - **experimentalDecorators**：启用装饰器支持，用于 `@Connect` 等装饰器语法

  - **baseUrl**：设置基础路径，用于解析非相对模块名

  - **paths**：路径映射配置，`"~/*"` 映射到 `"src/*"`，与项目路径别名保持一致

- **文件格式**：页面和组件文件格式改为 `.tsx` 即可使用 TypeScript 开发

- **注意事项**：

  - 安装依赖时需要使用 `-D` 参数，将 `ts-loader` 和 `typescript` 作为开发依赖安装

  - `tsconfig.json` 中的 `paths` 配置必须与项目的路径别名保持一致（`~` 指向 `src` 目录）

  - 配置变更后需要重启开发服务器才能生效

### 7. React 代码优化工具

- **工具说明**：

  - **工具名称**：`@cqjjb/react-code-optimization`

  - **技术实现**：本工具基于 Babel + Prettier 实现，用于对前端 React 项目中的代码进行自动化优化和格式化

  - **内置工具**：`@cqsjjb/scripts` 已内置代码优化工具（`code-optimization.js`），该工具基于 `@cqjjb/react-code-optimization` 实现，无需额外安装

- **主要能力**：

  - **导入语句排序**：

    - 按模块来源（`node_modules` / `~` / 相对路径等）进行分组

    - 按导入类型（默认导入 / 命名导入 / sideEffect 等）进行排序

    - 保证代码结构清晰，提升可读性

  - **JSX 属性排序**：

    - 对组件的属性进行规范化排序

    - 按照布尔属性、普通属性、事件属性等类型进行分组

    - 保持代码一致性，提升可维护性

  - **批量处理**：

    - 支持递归扫描目录

    - 对所有 `.js`、`.jsx`、`.mjs`、`.ejs` 文件进行优化

    - 自动处理整个项目的代码文件

- **使用方式**：

  - **方式一：使用命令行工具**

    ```bash
    # 进入目标目录，执行命令
    jjb-cmd opti
    ```

    - **前置条件**：请确保已全局安装 `jjb-cmd`

    - **使用场景**：适用于快速优化当前目录下的代码

  - **方式二：运行 package.json 中的脚本**（推荐）

    - **配置步骤**：在项目根目录的 `package.json` 文件的 `scripts` 中配置代码优化命令

    - **配置示例**：

      ```json
      // package.json
      {
        "scripts": {
          "code-optimization": "node node_modules/@cqsjjb/scripts/code-optimization.js"
        }
      }
      ```

    - **执行命令**：

      ```bash
      # 执行代码优化
      npm run code-optimization
      # 或
      yarn code-optimization
      ```

    - **注意事项**：

      1. 请确保已安装最新的 `@cqsjjb/scripts` 依赖包

      2. 执行命令将会优化应用所有代码

  - **方式三：使用 VSCode 插件**

    - **插件名称**：`cqjjb-react-code-optimization`

    - **工具基础**：该插件基于 `@cqjjb/react-code-optimization` 实现

    - **插件下载**：https://test-dragon-yf-pub.oss-cn-hangzhou.aliyuncs.com/jjb/2025/9/10/3bb86ae95aa94079bdbb4b5c8a6910e2.rar

    - **使用方式**：

      1. 安装插件后，在代码文件上右键菜单

      2. 选择 `Code Optimization` 选项

      3. 插件会自动优化当前文件

    - **使用场景**：适用于单个文件的快速优化

  - **方式四：手动优化代码（API 调用）**

    - **适用场景**：在自定义的构建流程、脚本或工具链中灵活使用

    - **使用示例**：

      ```javascript
      const { optimization, formation } = require('@cqjjb/react-code-optimization');

      const rawCode = `
        import React from 'react';
        import { Button } from 'antd';
        const App = (props) => <Button {...props} disabled type="primary" />;
      `;

      // 优化代码
      const optimizedCode = optimization(rawCode);

      // 格式化代码
      formation(optimizedCode, formattedCode => {
        console.log('最终优化结果：\n', formattedCode);
      });
      ```

    - **API 说明**：

      | 函数 | 说明 |
      | :--- | :--- |
      | `optimization(code)` | 优化代码，返回优化后的代码字符串 |
      | `formation(code, callback)` | 格式化代码，通过回调函数返回格式化后的代码 |

- **注意事项**：

  - **版本控制**：执行代码优化前，建议先提交代码到版本控制系统，以便回退

  - **代码检查**：优化工具会修改代码文件，建议在优化后检查代码变更，确保符合预期

  - **执行时间**：优化工具需要扫描整个 `src` 目录，大型项目可能需要较长时间

  - **文件类型**：工具会自动处理 `.js`、`.jsx`、`.mjs`、`.ejs` 文件，其他文件类型不会被处理

  - **备份建议**：对于重要项目，建议在执行批量优化前先备份代码

### 8. 开发服务配置

- **配置来源**：开发服务配置来源于根目录 `jjb.config.js` 文件中的 `server` 属性

- **配置结构**：

  ```javascript
  // jjb.config.js
  {
    server: {
      // 监听端口号
      port: '8082',
      // 服务地址
      host: '127.0.0.1',
      // 是否自动打开浏览器
      open: false,
    }
  }
  ```

- **配置说明**：

  - **port**：开发服务器监听的端口号，默认为 `'8082'`

  - **host**：开发服务器绑定的主机地址，默认为 `'127.0.0.1'`（本地访问）

  - **open**：启动开发服务器时是否自动打开浏览器，默认为 `false`

- **使用场景**：此配置用于控制本地开发环境的服务行为，不影响生产环境部署

### 9. 静态资源服务器配置

- **配置来源**：静态资源服务器配置来源于根目录 `jjb.config.js` 文件中的 `www` 属性

- **功能说明**：静态资源服务器用于预览构建后的静态资源文件，基于 Express 搭建，支持 CORS 和单页面应用（SPA）路由

- **配置结构**：

  ```javascript
  // jjb.config.js
  {
    www: {
      // 服务器端口号
      port: 8566,
      // 服务器主机地址
      host: 'localhost',
      // CORS 配置
      cors: '*',
      // 静态资源目录
      static: 'dist'
    }
  }
  ```

- **配置说明**：

  | 配置项 | 类型 | 说明 | 默认值 |
  | :--- | :--- | :--- | :--- |
  | `port` | number | 静态资源服务器监听的端口号 | `8566` |
  | `host` | string | 静态资源服务器绑定的主机地址 | `'localhost'` |
  | `cors` | string | CORS（跨域资源共享）配置，支持通配符 `'*'` 或具体域名 | `'*'` |
  | `static` | string | 静态资源目录路径，相对于项目根目录 | `'dist'` |

- **使用场景**：

  - **预览构建产物**：构建完成后，启动静态资源服务器预览生产环境构建结果

  - **本地测试**：在本地环境中测试构建后的应用，验证构建产物是否正确

  - **跨域测试**：通过配置 CORS 支持跨域访问测试

- **启动命令**：

  ```bash
  # 启动静态资源服务器
  npm run www
  # 或
  yarn www
  ```

- **访问地址**：根据配置的 `host` 和 `port`，默认访问地址为 `http://localhost:8566`

- **注意事项**：

  - 启动静态资源服务器前，需要先执行构建命令生成 `dist` 目录

  - 如果 `static` 配置的目录不存在，服务器会启动但可能无法正常提供服务

  - 静态资源服务器支持单页面应用（SPA）的路由回退，所有路由都会回退到 `index.html`

  - CORS 配置在生产环境中应设置为具体域名，避免使用通配符 `'*'` 带来的安全风险

### 10. 应用启动与编译

- **重要说明**：**必须指定环境**，不支持直接使用 `npm run serve` 或 `npm run build`，所有启动和构建命令都需要指定环境参数。

- **开发环境启动**：

  - **命令格式**：`npm run serve:<环境>` 或 `yarn serve:<环境>`

  - **功能说明**：启动开发服务器，支持热更新，代码修改后自动刷新浏览器

  - **访问地址**：根据 `jjb.config.js` 中的 `server` 配置，默认访问地址为 `http://127.0.0.1:8082`

  - **环境配置**：启动时会自动加载 `jjb.config.js` 中 `environment.<环境>` 的对应配置

  - **启动示例**：

    ```bash
    # 启动开发环境
    npm run serve:development

    # 启动测试（UAT）环境
    npm run serve:uat
    ```

- **生产环境构建**：

  - **命令格式**：`npm run build:<环境>` 或 `yarn build:<环境>`

  - **功能说明**：执行指定环境的构建，生成优化后的静态资源文件

  - **构建产物**：构建完成后会在项目根目录生成 `dist` 文件夹，包含以下内容：

    ```
    dist/
    ├── <appIdentifier>/
    │   └── static/
    │       ├── css/
    │       ├── js/
    │       └── ...
    └── <appIdentifier>.html
    ```

  - **构建产物命名**：构建产物目录和文件名基于 `jjb.config.js` 中的 `appIdentifier` 配置生成

  - **环境配置**：构建时会自动加载 `jjb.config.js` 中 `environment.<环境>` 的对应配置

  - **构建示例**：

    ```bash
    # 构建开发环境
    npm run build:development

    # 构建测试（UAT）环境
    npm run build:uat

    # 构建生产环境
    npm run build:production
    ```

- **环境映射机制**：

  - **环境参数**：命令中的环境参数会映射到 `jjb.config.js` 中 `environment` 对象的对应配置

  - **环境配置示例**：

    ```javascript
    // jjb.config.js
    {
      environment: {
        development: {
          API_HOST: 'http://10.43.250.65'
        },
        uat: {
          API_HOST: 'http://10.43.82.219'
        },
        production: {
          API_HOST: 'https://api.example.com'
        }
      }
    }
    ```

  - **配置说明**：执行 `npm run serve:development` 时，会加载 `environment.development` 的配置；执行 `npm run build:uat` 时，会加载 `environment.uat` 的配置

- **常用命令总结**：

  | 命令 | 说明 |
  | :--- | :--- |
  | `npm run serve:development` | 启动开发环境服务器 |
  | `npm run serve:uat` | 启动测试（UAT）环境服务器 |
  | `npm run build:development` | 构建开发环境 |
  | `npm run build:uat` | 构建测试（UAT）环境 |
  | `npm run build:production` | 构建生产环境 |

- **编译缓存管理**：

  - **缓存文件位置**：本地开发服务（devServer）运行会生成大量的文件热更新编译缓存包，缓存文件路径为 `node_modules/.cache`

  - **注意事项**：

    1. **缓存清理必要性**：若长期没有删除缓存会导致应用热更新卡顿、文件磁盘占用过大等问题

    2. **依赖更新影响**：若安装了新的依赖或依赖版本升级，没有删除缓存，可能导致仍然使用旧依赖的问题

    3. **删除缓存时机**：**删除缓存前必须暂停 devServer，否则会导致服务异常**

  - **清理方式**：

    ```bash
    # 1. 先停止开发服务器（Ctrl + C）
    # 2. 删除缓存目录
    rm -rf node_modules/.cache
    # Windows 系统使用：
    # rmdir /s /q node_modules\.cache
    ```

- **注意事项**：

  - 启动开发服务器前，确保已安装所有依赖（`npm install` 或 `yarn install`）

  - 构建命令执行前，建议先清理之前的构建产物

  - 不同环境的构建产物会使用对应环境的接口地址配置

  - 构建完成后，可通过 `jjb-cmd push java <环境>` 命令将构建产物推送到后端仓库（参考"构建与部署"章节）

  - 定期清理编译缓存，避免热更新卡顿和磁盘占用过大问题

### 11. HTML 模板配置

- **配置来源**：HTML 模板配置来源于根目录 `jjb.config.js` 文件中的 `windowInject` 属性

- **配置结构**：

  ```javascript
  // jjb.config.js
  {
    windowInject: {
      // 应用标题
      title: '微应用',
      // 注入 CSS 链接集合
      links: ['https://test.test.com/index.js'],
      element: {
        root: {
          // 挂载 DOM 元素 ID
          id: 'root',
        },
      },
      // 注入 JS 链接集合
      scripts: ['https://test.test.com/index.js'],
    }
  }
  ```

- **配置说明**：

  - **title**：应用标题，会注入到 HTML 模板的 `<title>` 标签中

  - **links**：CSS 样式文件链接数组，用于在 HTML 头部注入外部样式表

  - **element.root.id**：React 应用挂载的 DOM 元素 ID，默认为 `'root'`

  - **scripts**：JavaScript 文件链接数组，用于在 HTML 中注入外部脚本文件

- **模板使用方式**：在 `index.html` 模板中通过 EJS 模板语法访问配置

  - **变量注入**：`windowInject` 配置会注入到 `htmlWebpackPlugin.options` 中，需要在模板中先解构获取变量

  - **模板示例**：

    ```html
    <!-- 解构配置变量 -->
    <% var { links, scripts, element, title } = htmlWebpackPlugin.options %>

    <!-- 注入 CSS 链接 -->
    <% for (const item of links) { %>
      <link type="text/css" rel="stylesheet" href="<%= item %>"></link>
    <% } %>

    <!-- 注入 JS 脚本 -->
    <% for (const item of scripts) { %>
      <script src="<%= item %>" type="text/javascript"></script>
    <% } %>

    <!-- 使用元素配置 -->
    <% const { root } = element; %>
    <div id="<%= root.id %>" style="width: 100%; height: 100%; position: relative"></div>
    ```

  - **变量说明**：

    - `links`：对应配置中的 `links` 数组，用于循环注入 CSS 链接

    - `scripts`：对应配置中的 `scripts` 数组，用于循环注入 JS 脚本

    - `element`：对应配置中的 `element` 对象，用于访问挂载元素配置

    - `title`：对应配置中的 `title` 字符串，可用于设置页面标题

- **使用场景**：适用于需要在 HTML 模板中动态注入外部资源（CSS、JS）或配置应用挂载点的场景

### 12. HTTP 拦截器配置

- **配置位置**：在 `public/index.html` 文件中配置 `window.jjbCommonGlobalConfig.httpInterceptor`

- **配置结构**：

  ```html
  <script>
    window.jjbCommonGlobalConfig = {
      // http拦截器
      httpInterceptor: {
        // 请求拦截
        request: (url, method, data, headers) => {
          // 处理你的请求拦截逻辑
          
          // 示例：给请求头添加一个租户ID
          if (!headers) {
            headers = {};
          }
          headers.tenantId = sessionStorage.getItem('tenantId');
          
          // 示例：修改请求URL
          // url = url.replace('/old-path', '/new-path');
          
          // 示例：修改请求数据
          // data = { ...data, timestamp: Date.now() };
          
          // 必须返回 Promise，resolve 值为数组 [url, method, data, headers]
          return Promise.resolve([
            url,
            method,
            data,
            headers
          ]);
        },
        // 响应拦截
        response: res => {
          // 处理你的响应拦截逻辑
          
          // 示例：统一处理响应数据
          // if (res.data && res.data.code === 200) {
          //   return Promise.resolve(res.data);
          // }
          
          // 示例：错误处理
          // if (res.response && res.response.status !== 200) {
          //   console.error('请求失败:', res.response.status);
          // }
          
          // 必须返回 Promise，resolve 值为处理后的响应对象
          return Promise.resolve(res);
        }
      }
    }
  </script>
  ```

- **请求拦截器说明**：

  - **函数签名**：`request(url: string, method: string, data?: object, headers?: object | false): Promise<[string, string, object, object | false]>`

  - **参数说明**：

    | 参数 | 类型 | 说明 |
    | :--- | :--- | :--- |
    | url | string | 请求URL地址 |
    | method | string | 请求方法（如 'get'、'post'、'put'、'delete'、'patch'） |
    | data | object | 请求数据（可选，默认为 `{}`） |
    | headers | object \| false | 请求头对象（可选，默认为 `false`，如果为 `false` 则使用默认请求头） |

  - **返回值**：**必须返回 Promise**，Promise resolve 的值必须为包含四个元素的数组：`[url, method, data, headers]`

    - 数组元素顺序固定：`[URL地址, 请求方法, 请求数据, 请求头]`
    - 返回的数组会作为参数传递给实际的请求函数执行

  - **执行时机**：在请求发送前执行，可以修改请求的 URL、方法、数据和请求头

  - **使用示例**：

    ```javascript
    request: (url, method, data, headers) => {
      // 确保 headers 是对象
      const reqHeaders = headers || {};
      
      // 添加 Token
      if (!reqHeaders.token && sessionStorage.getItem('token')) {
        reqHeaders.token = sessionStorage.getItem('token');
      }
      
      // 添加租户ID
      reqHeaders.tenantId = sessionStorage.getItem('tenantId');
      
      // 修改请求数据
      const reqData = {
        ...data,
        timestamp: Date.now()
      };
      
      return Promise.resolve([url, method, reqData, reqHeaders]);
    }
    ```

  - **使用场景**：适用于需要在请求发送前统一处理请求参数、添加请求头（如租户ID、Token等）、修改请求URL、添加时间戳等场景

- **响应拦截器说明**：

  - **函数签名**：`response(res: object): Promise<object>`

  - **参数说明**：

    | 参数 | 类型 | 说明 |
    | :--- | :--- | :--- |
    | res | object | 响应对象，包含完整的响应信息（成功时包含 `data`、`status` 等，失败时包含 `response`、`message` 等） |

  - **返回值**：**必须返回 Promise**，Promise resolve 的值为处理后的响应对象

  - **执行时机**：在响应返回后执行，**无论请求成功还是失败都会执行**

    - 成功时：响应对象包含 `data`、`status`、`headers` 等属性
    - 失败时：响应对象包含 `response`、`message`、`code` 等错误信息

  - **使用示例**：

    ```javascript
    response: res => {
      // 成功响应处理
      if (res.data && res.status === 200) {
        // 统一处理响应数据格式
        return Promise.resolve({
          ...res.data,
          success: res.data.success !== false
        });
      }
      
      // 错误响应处理
      if (res.response) {
        console.error('请求失败:', res.response.status, res.response.data);
      }
      
      return Promise.resolve(res);
    }
    ```

  - **使用场景**：适用于需要在响应返回后统一处理响应数据、错误处理、数据格式转换、统一错误提示等场景

- **注意事项**：

  - **配置时机**：HTTP 拦截器配置必须在应用启动前完成，建议放在 `public/index.html` 的 `<head>` 或 `<body>` 开始位置

  - **请求拦截器要求**：
    - 必须返回 Promise 对象
    - Promise resolve 的值必须为包含四个元素的数组：`[url, method, data, headers]`
    - 数组元素顺序固定，不能改变
    - 如果不需要修改某个参数，也需要原样返回

  - **响应拦截器要求**：
    - 必须返回 Promise 对象
    - Promise resolve 的值为处理后的响应对象
    - 响应拦截器会在请求成功和失败时都被调用，需要根据实际情况处理

  - **参数处理**：
    - 请求拦截器的 `headers` 参数可能为 `false`，使用时需要先判断或转换为对象
    - 请求拦截器的 `data` 参数默认为 `{}`，但可能为任意对象结构

  - **错误处理**：
    - 拦截器中的异步操作应使用 Promise 处理，确保拦截器链的正常执行
    - 如果拦截器抛出错误或返回的 Promise reject，可能导致请求失败

### 13. 构建工具说明

- **构建工具**：`@cqsjjb/scripts` 是微应用开发和编译构建工具

  - **技术实现**：早期版本基于 Webpack 5 实现，最新版本基于 Rspack 实现

  - **配置扩展**：构建工具的扩展配置在 `jjb.config.js` 的 `webpackConfig` 属性中进行

  - **主要功能**：
    - 开发服务器启动与管理
    - 生产环境构建与打包
    - 根据 `appIdentifier` 生成构建产物目录结构

### 14. Webpack/Rspack 配置扩展

- **配置来源**：Rspack 配置扩展来源于根目录 `jjb.config.js` 文件中的 `webpackConfig` 属性

- **配置说明**：

  - **兼容性**：`webpackConfig` 兼容 Webpack 配置格式，支持自定义 Rspack 构建配置

  - **配置合并机制**：用户配置会与 `@cqsjjb/scripts` 默认配置进行合并，相同配置项会覆盖默认值

  - **默认配置**：`@cqsjjb/scripts` 已内置常用配置（如 CSS/LESS 处理、JS/TS 编译、图片/字体/媒体资源处理等），用户只需配置特殊需求

- **支持的配置项**：

  ```javascript
  // jjb.config.js
  {
    webpackConfig: {
      // 入口文件（可选，默认: 'src/main.js'）
      entry: 'src/main.js',
      
      // 输出配置（可选）
      output: {
        path: 'dist',
        publicPath: '/',
        filename: '[name].[hash].js'
      },
      
      // 模块解析配置（可选，会与默认配置合并）
      resolve: {
        alias: {
          '@': path.resolve(__dirname, 'src')
        }
      },
      
      // 模块规则配置（可选，会追加到默认规则后）
      module: {
        rules: [
          // 自定义 loader 规则
        ]
      },
      
      // 外部依赖配置（可选）
      externals: {
        'react': 'React',
        'react-dom': 'ReactDOM'
      },
      
      // 插件配置（可选）
      plugins: [
        // 自定义插件
      ],
      
      // 优化配置（可选）
      optimization: {
        minimize: true,
        splitChunks: {
          chunks: 'all'
        }
      },
      
      // HTML Webpack 插件配置（可选）
      htmlWebpackPluginOption: {
        inject: true
      },
      
      // 统计信息配置（可选）
      stats: {
        assets: true,
        chunks: false
      }
    }
  }
  ```

- **配置项说明**：

  | 配置项 | 类型 | 说明 | 默认值 |
  | :--- | :--- | :--- | :--- |
  | `entry` | string | 应用入口文件路径 | `'src/main.js'` |
  | `output` | object | 输出配置（path、publicPath、filename 等） | 根据 `appIdentifier` 自动生成 |
  | `resolve` | object | 模块解析配置（alias、extensions 等） | 默认包含 `~` 别名指向 `src` |
  | `module.rules` | array | 模块规则配置（loader 规则） | 默认包含 CSS/LESS、JS/TS、图片/字体/媒体处理规则 |
  | `externals` | object | 外部依赖配置 | `{}` |
  | `plugins` | array | 插件配置 | 默认包含 HTML 插件等 |
  | `optimization` | object | 优化配置（minimize、splitChunks 等） | 生产模式自动启用 |
  | `htmlWebpackPluginOption` | object | HTML Webpack 插件配置 | `{ inject: true }` |
  | `stats` | object | 构建统计信息配置 | 默认配置 |

- **配置示例**：

  - **示例1：自定义路径别名**

    ```javascript
    // jjb.config.js
    const path = require('path');

    module.exports = {
      // ...其他配置
      webpackConfig: {
        resolve: {
          alias: {
            '@': path.resolve(__dirname, 'src'),
            '@components': path.resolve(__dirname, 'src/components')
          }
        }
      }
    }
    ```

  - **示例2：自定义文件加载器（Loader）**

    ```javascript
    // jjb.config.js
    const appIdentifier = 'system';

    module.exports = {
      // ...其他配置
      webpackConfig: {
        module: {
          rules: [
            {
              // 加载MD文件
              test: /\.(md)$/,
              use: [
                {
                  loader: 'file-loader',
                  options: {
                    name: '[name].[hash].[ext]',
                    outputPath: appIdentifier + '/static/doc/'
                  }
                }
              ]
            }
          ]
        }
      }
    }
    ```

  - **示例3：配置外部依赖**

    ```javascript
    // jjb.config.js
    module.exports = {
      // ...其他配置
      webpackConfig: {
        externals: {
          'react': 'React',
          'react-dom': 'ReactDOM',
          'antd': 'antd'
        }
      }
    }
    ```

- **配置合并规则**：

  - **resolve**：用户配置会与默认配置合并，默认配置包含 `~` 别名指向 `src` 目录

  - **module.rules**：用户配置的规则会**追加**到默认规则后，不会覆盖默认规则

  - **其他配置项**：用户配置会覆盖默认配置

- **默认内置规则**：

  `@cqsjjb/scripts` 已内置以下处理规则，无需重复配置：

  - **CSS/LESS 文件**：自动处理 `.css` 和 `.less` 文件
  - **JS/TS 文件**：自动处理 `.js`、`.jsx`、`.ts`、`.tsx` 文件（使用 Babel）
  - **图片文件**：自动处理 `.png`、`.jpg`、`.jpeg`、`.gif`、`.ico`、`.bmp`、`.svg` 文件
  - **字体文件**：自动处理 `.eot`、`.woff`、`.ttf` 文件
  - **媒体文件**：自动处理 `.mp3`、`.mp4` 文件

- **配置参考**：所有配置项遵循 Webpack/Rspack 官方文档规范，具体配置选项请参考：

  - [Rspack 官方文档](https://rspack.dev/)
  - [Webpack 官方文档](https://webpack.js.org/configuration/)（Rspack 兼容 Webpack 配置格式）

- **使用场景**：适用于需要自定义构建行为、添加插件、配置别名、优化打包、处理特殊文件类型等高级构建需求

- **注意事项**：

  - **配置合并**：用户配置会与默认配置合并，`resolve` 和 `module.rules` 采用合并策略，其他配置项采用覆盖策略

  - **默认规则保留**：`module.rules` 中用户自定义的规则会追加到默认规则后，不会影响默认的 CSS/LESS、JS/TS、图片/字体/媒体处理规则

  - **谨慎配置**：建议仅在必要时进行扩展配置，避免过度自定义导致构建问题

  - **配置生效**：配置变更后需要重启开发服务器或重新构建才能生效

  - **路径别名**：默认已配置 `~` 别名指向 `src` 目录，用户可以通过 `resolve.alias` 添加其他别名，但建议保留 `~` 别名
